<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.I.X. Autrement - Nos Références</title>
    
    <!-- Polices Charte D.I.X. -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500&family=Georgia&display=swap" rel="stylesheet">
    
    <!-- Bibliothèques externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>

    <style>
        :root {
            --dix-dark-green: #405F59;
            --dix-light-green: #549e39;
            --dix-white-grey: #f3f3f3;
        }

        body { font-family: 'Georgia', serif; color: var(--dix-dark-green); overflow: hidden; background-color: white; }
        h1, h2, h3, h4, .font-oswald { 
            font-family: 'Oswald', sans-serif; 
            text-transform: uppercase;
            font-weight: 400;
        }
        
        #map { height: 100%; width: 100%; background: #f8fafc; z-index: 1; }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--dix-light-green); border-radius: 10px; }

        .active-card { border-left: 4px solid var(--dix-light-green) !important; background-color: white !important; transform: translateX(5px); }
        
        .marker-dot { transition: all 0.2s ease; }
        
        /* Animation du panneau de détails : Glissement depuis la droite */
        #detailPanel { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        }

        .logo-container {
            max-width: 140px;
            max-height: 70px;
            object-fit: contain;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            #detailPanel { 
                top: auto !important;
                bottom: 0 !important; 
                left: 0 !important; 
                right: 0 !important; 
                width: 100% !important;
                border-radius: 20px 20px 0 0; 
                max-height: 75vh; 
                transform: translateY(150%);
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- HEADER -->
    <header class="p-4 md:p-6 border-b bg-white relative z-10 shadow-sm">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="hidden md:flex w-12 h-12 bg-[var(--dix-dark-green)] rounded-full items-center justify-center text-white font-oswald text-xl">D</div>
                <div>
                    <h1 class="text-2xl md:text-3xl tracking-widest text-[var(--dix-dark-green)]">Nos Références</h1>
                    <div class="w-16 h-1 mt-1 bg-[var(--dix-light-green)]"></div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3 w-full md:w-auto">
                <div class="relative flex-grow md:w-64">
                    <input type="text" id="searchInput" placeholder="Rechercher une mission..." 
                        class="w-full pl-10 pr-4 py-2 border rounded-full text-sm outline-none focus:ring-1 focus:ring-[var(--dix-light-green)] border-gray-200 bg-[var(--dix-white-grey)]/50 shadow-inner">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <select id="themeFilter" class="px-4 py-2 border rounded-full text-xs uppercase tracking-widest outline-none bg-white border-gray-200 cursor-pointer hover:border-[var(--dix-light-green)]">
                    <option value="">Filtrer par type</option>
                </select>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full h-1/3 md:h-auto md:w-1/3 lg:w-1/4 bg-[var(--dix-white-grey)]/40 border-r overflow-y-auto custom-scroll p-4 space-y-3">
            <div id="loader" class="flex flex-col items-center justify-center py-20 text-gray-400 text-center px-4">
                <div id="loaderIcon" class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--dix-light-green)] mb-2"></div>
                <p id="loaderStatus" class="text-[10px] uppercase tracking-widest font-bold">Démarrage...</p>
                <p id="loaderHint" class="text-[9px] mt-2 opacity-60">Préparation de l'interface</p>
            </div>
            <div id="resultsList" class="space-y-3 hidden"></div>
        </div>

        <!-- MAP CONTAINER -->
        <div class="flex-1 relative">
            <div id="map"></div>
            
            <!-- DETAIL PANEL -->
            <div id="detailPanel" class="absolute top-6 right-6 w-[calc(100%-3rem)] md:w-96 bg-white rounded-2xl shadow-2xl p-6 border-t-8 border-[var(--dix-dark-green)] transform translate-x-[120%] z-[1000] overflow-hidden">
                <button onclick="closeDetails()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <div class="flex flex-col gap-2">
                    <!-- Zone Logo Client -->
                    <div id="detLogoContainer" class="hidden flex justify-start">
                        <img id="detLogo" src="" alt="Logo client" class="logo-container">
                    </div>

                    <div class="flex items-center gap-3">
                        <span id="detYear" class="bg-[var(--dix-white-grey)] text-[10px] font-bold px-2 py-1 rounded text-[var(--dix-dark-green)]"></span>
                        <span id="detTheme" class="text-[10px] uppercase tracking-widest font-bold text-[var(--dix-light-green)]"></span>
                    </div>
                    <h2 id="detTitle" class="text-xl text-[var(--dix-dark-green)] leading-tight font-oswald"></h2>
                    <p id="detClient" class="text-sm font-bold text-gray-500"></p>
                    <div class="h-px bg-gray-100 w-full my-3"></div>
                    <div id="detDesc" class="text-gray-600 text-sm italic leading-relaxed whitespace-pre-line max-h-60 overflow-y-auto custom-scroll pr-2"></div>
                    <div class="flex items-center gap-2 mt-4 text-[10px] text-gray-400 uppercase tracking-widest font-oswald border-t pt-4">
                        <i data-lucide="map-pin" class="w-3 h-3 text-[var(--dix-light-green)]"></i>
                        <span id="detLoc"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t p-2 text-[9px] uppercase tracking-[0.3em] text-center text-gray-400 font-oswald">
        D.I.X. Autrement — Modélisation & Évaluation de circuits de proximité
    </footer>

    <script>
        // CONFIGURATION
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm_4bPCRFK_gGVkxP-ZeTHzLauhQtqNg_zG2chKNuY8-iyDAuHjc_CQbpBCU4LY9-GRi1579CsUkhr/pub?gid=917397259&single=true&output=csv";
        
        let COLS = {
            ANNEE: 0, 
            REGION: 1, 
            LOGO: 2, 
            CLIENT: 3, 
            TYPE: 4, 
            TITRE: 5, 
            DESC: 6, 
            VILLE: 8, 
            LAT: 9, 
            LNG: 10
        };

        let allData = [];
        let map, markersLayer;

        function updateLoaderStatus(status, hint = "") {
            const statusEl = document.getElementById('loaderStatus');
            const hintEl = document.getElementById('loaderHint');
            const iconEl = document.getElementById('loaderIcon');
            if (statusEl) statusEl.textContent = status;
            if (hintEl) hintEl.textContent = hint;
            if (status.includes("Erreur") && iconEl) iconEl.classList.remove('animate-spin');
        }

        window.onload = function() {
            try {
                updateLoaderStatus("Chargement...", "Initialisation de la carte");
                if (window.lucide) lucide.createIcons();
                initMap();
                loadData();
            } catch (err) {
                updateLoaderStatus("Erreur Système", "Le script n'a pas pu démarrer.");
            }
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([46.80, 2.50], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            updateLoaderStatus("Carte prête", "Connexion au Google Sheet");
        }

        // Nettoie l'URL au cas où elle arrive avec des résidus de formule
        function cleanUrl(text) {
            if (!text) return null;
            let url = text.trim();
            // Si c'est une formule, on extrait ce qu'il y a entre guillemets
            const match = url.match(/["'](http[^"']+)["']/i);
            if (match) return match[1];
            // Sinon si c'est déjà une URL pure
            if (url.startsWith('http')) return url;
            return null;
        }

        function loadData() {
            updateLoaderStatus("Lecture...", "Récupération des références");
            Papa.parse(CSV_URL, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length < 2) {
                        updateLoaderStatus("Erreur : Fichier vide", "Vérifiez la publication de votre onglet.");
                        return;
                    }
                    const rows = results.data.slice(1);
                    
                    allData = rows.map((row, index) => {
                        try {
                            const cleanCoord = (val) => String(val || "").replace(/\s/g, '').replace(',', '.').trim();
                            const lat = parseFloat(cleanCoord(row[COLS.LAT]));
                            const lng = parseFloat(cleanCoord(row[COLS.LNG]));
                            if (isNaN(lat) || isNaN(lng)) return null;

                            return {
                                id: index,
                                year: row[COLS.ANNEE] || "N/C",
                                region: row[COLS.REGION] || "N/C",
                                logo: cleanUrl(row[COLS.LOGO]),
                                client: row[COLS.CLIENT] || "Client",
                                theme: row[COLS.TYPE] || "Autre",
                                title: row[COLS.TITRE] || "Sans titre",
                                desc: row[COLS.DESC] || "",
                                city: row[COLS.VILLE] || "",
                                lat: lat,
                                lng: lng
                            };
                        } catch (err) { return null; }
                    }).filter(item => item !== null);

                    if (allData.length === 0) {
                        updateLoaderStatus("Erreur : GPS manquant", "Aucune coordonnée Latitude/Longitude lisible.");
                        return;
                    }
                    renderFilters();
                    render(allData);
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('resultsList').classList.remove('hidden');
                },
                error: function(err) {
                    updateLoaderStatus("Erreur de lien", "L'URL du Google Sheet est inaccessible.");
                }
            });
        }

        function renderFilters() {
            const themes = [...new Set(allData.map(d => d.theme))].filter(Boolean).sort();
            const select = document.getElementById('themeFilter');
            themes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                select.appendChild(opt);
            });
        }

        function render(data) {
            const listContainer = document.getElementById('resultsList');
            listContainer.innerHTML = '';
            markersLayer.clearLayers();
            data.forEach(item => {
                const card = document.createElement('div');
                card.id = `card-${item.id}`;
                card.className = "p-4 bg-white rounded-xl cursor-pointer transition-all shadow-sm hover:shadow-md border border-gray-100 group";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[9px] font-bold px-1.5 py-0.5 bg-gray-100 rounded group-hover:bg-[var(--dix-light-green)] group-hover:text-white transition-colors">${item.year}</span>
                        <span class="text-[9px] uppercase tracking-tighter text-[var(--dix-light-green)] font-bold">${item.theme || ''}</span>
                    </div>
                    <h4 class="text-sm leading-tight text-[var(--dix-dark-green)] font-oswald">${item.title ? item.title.toUpperCase() : 'SANS TITRE'}</h4>
                    <p class="text-[10px] font-bold text-gray-400 mt-1">${item.client || ''}</p>
                `;
                card.onclick = () => selectRef(item);
                listContainer.appendChild(card);

                const markerIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="marker-dot" style="background-color: var(--dix-light-green); width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`,
                    iconSize: [14, 14], iconAnchor: [7, 7]
                });
                L.marker([item.lat, item.lng], { icon: markerIcon }).addTo(markersLayer).on('click', () => selectRef(item));
            });
        }

        function selectRef(item) {
            document.querySelectorAll('#resultsList > div').forEach(el => el.classList.remove('active-card'));
            const card = document.getElementById(`card-${item.id}`);
            if(card) {
                card.classList.add('active-card');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            map.flyTo([item.lat, item.lng], 10, { duration: 1.2 });
            
            document.getElementById('detTitle').textContent = item.title ? item.title.toUpperCase() : '';
            document.getElementById('detClient').textContent = item.client;
            document.getElementById('detYear').textContent = item.year;
            document.getElementById('detTheme').textContent = item.theme;
            document.getElementById('detDesc').textContent = item.desc;
            document.getElementById('detLoc').textContent = `${item.city || ''} (${item.region || ''})`;
            
            // Affichage du Logo
            const logoCont = document.getElementById('detLogoContainer');
            const logoImg = document.getElementById('detLogo');
            if (item.logo) {
                logoImg.src = item.logo;
                logoCont.classList.remove('hidden');
            } else {
                logoCont.classList.add('hidden');
            }
            
            const panel = document.getElementById('detailPanel');
            if (window.innerWidth <= 768) {
                panel.style.transform = "translateY(0)";
            } else {
                panel.style.transform = "translateX(0)";
            }
        }

        function closeDetails() {
            const panel = document.getElementById('detailPanel');
            if (window.innerWidth <= 768) {
                panel.style.transform = "translateY(150%)";
            } else {
                panel.style.transform = "translateX(120%)";
            }
            document.querySelectorAll('#resultsList > div').forEach(el => el.classList.remove('active-card'));
        }

        document.getElementById('searchInput').oninput = filterData;
        document.getElementById('themeFilter').onchange = filterData;

        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const theme = document.getElementById('themeFilter').value;
            const filtered = allData.filter(d => {
                const matchesSearch = (d.title || "").toLowerCase().includes(search) || (d.client || "").toLowerCase().includes(search);
                const matchesTheme = theme === "" || d.theme === theme;
                return matchesSearch && matchesTheme;
            });
            render(filtered);
            closeDetails();
        }
    </script>
</body>
</html>
