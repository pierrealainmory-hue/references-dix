<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.I.X. Autrement - Nos Références</title>
    
    <!-- Polices Charte D.I.X. -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500&family=Georgia&display=swap" rel="stylesheet">
    
    <!-- Bibliothèques externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>

    <style>
        :root {
            --dix-dark-green: #405F59;
            --dix-light-green: #549e39;
            --dix-white-grey: #f3f3f3;
        }

        body { font-family: 'Georgia', serif; color: var(--dix-dark-green); overflow: hidden; background-color: white; height: 100vh; }
        h1, h2, h3, h4, .font-oswald { 
            font-family: 'Oswald', sans-serif; 
            text-transform: uppercase;
            font-weight: 400;
        }
        
        #map { height: 100%; width: 100%; background: #f8fafc; z-index: 1; }
        
        /* Barre de défilement discrète */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--dix-light-green); border-radius: 10px; }

        .active-card { border-left: 4px solid var(--dix-light-green) !important; background-color: white !important; transform: translateX(5px); }
        
        .marker-dot { transition: all 0.2s ease; cursor: pointer; }
        
        /* Panneau de détails : Responsive et Scrollable */
        #detailPanel { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .logo-container {
            max-width: 140px;
            max-height: 60px;
            object-fit: contain;
            margin-bottom: 1rem;
        }

        /* Fixation absolue de l'en-tête pour l'iframe */
        header { 
            position: sticky; 
            top: 0; 
            background: white; 
            z-index: 100; 
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) {
            #detailPanel { 
                top: auto !important;
                bottom: 0 !important; 
                left: 0 !important; 
                right: 0 !important; 
                width: 100% !important;
                border-radius: 20px 20px 0 0; 
                max-height: 80vh !important; 
                transform: translateY(150%);
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- HEADER / FILTRES (Reste toujours visible dans l'iframe) -->
    <header class="p-3 md:p-5 border-b">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="hidden md:flex w-10 h-10 bg-[var(--dix-dark-green)] rounded-full items-center justify-center text-white font-oswald text-lg">D</div>
                <div>
                    <h1 class="text-xl md:text-2xl tracking-widest text-[var(--dix-dark-green)]">Nos Références</h1>
                    <div class="w-12 h-0.5 mt-1 bg-[var(--dix-light-green)]"></div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <div class="relative flex-grow md:w-64">
                    <input type="text" id="searchInput" placeholder="Rechercher une mission..." 
                        class="w-full pl-9 pr-4 py-1.5 border rounded-full text-xs outline-none focus:ring-1 focus:ring-[var(--dix-light-green)] border-gray-200 bg-[var(--dix-white-grey)]/50 shadow-inner">
                    <i data-lucide="search" class="absolute left-3 top-2 text-gray-400 w-3.5 h-3.5"></i>
                </div>
                <select id="themeFilter" class="px-3 py-1.5 border rounded-full text-[9px] uppercase tracking-widest outline-none bg-white border-gray-200 cursor-pointer hover:border-[var(--dix-light-green)] transition-colors">
                    <option value="">Toutes les thématiques</option>
                </select>
            </div>
        </div>
    </header>

    <!-- MAIN (Zones défilables indépendamment) -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full h-1/3 md:h-auto md:w-1/3 lg:w-1/4 bg-[var(--dix-white-grey)]/40 border-r overflow-y-auto custom-scroll p-3 space-y-2.5">
            <div id="loader" class="flex flex-col items-center justify-center py-20 text-gray-400 text-center px-4">
                <div id="loaderIcon" class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--dix-light-green)] mb-2"></div>
                <p id="loaderStatus" class="text-[10px] uppercase tracking-widest font-bold">Mise à jour en direct...</p>
            </div>
            <div id="resultsList" class="space-y-2.5 hidden"></div>
        </div>

        <!-- ZONE CARTE -->
        <div class="flex-1 relative overflow-hidden">
            <div id="map"></div>
            
            <!-- DETAIL PANEL -->
            <div id="detailPanel" class="absolute top-4 right-4 w-[calc(100%-2rem)] md:w-[420px] bg-white rounded-2xl shadow-2xl p-5 md:p-7 border-t-8 border-[var(--dix-dark-green)] transform translate-x-[120%] z-[1000] custom-scroll">
                <button onclick="closeDetails()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                
                <div class="flex flex-col gap-1.5">
                    <div id="detLogoContainer" class="hidden flex justify-start">
                        <img id="detLogo" src="" alt="Logo client" class="logo-container">
                    </div>

                    <div class="flex items-center gap-2 mb-1">
                        <span id="detYear" class="bg-[var(--dix-white-grey)] text-[8px] font-bold px-1.5 py-0.5 rounded text-[var(--dix-dark-green)]"></span>
                        <span id="detTheme" class="text-[8px] uppercase tracking-widest font-bold text-[var(--dix-light-green)]"></span>
                    </div>
                    <h2 id="detTitle" class="text-base md:text-lg text-[var(--dix-dark-green)] leading-tight font-oswald mb-0.5"></h2>
                    <p id="detClient" class="text-xs font-bold text-gray-500"></p>
                    <div class="h-px bg-gray-100 w-full my-2.5"></div>
                    <div id="detDesc" class="text-gray-600 text-[11px] md:text-xs italic leading-relaxed whitespace-pre-line pr-2 mb-3"></div>
                    <div class="flex items-center gap-2 mt-2 text-[8px] text-gray-400 uppercase tracking-widest font-oswald border-t pt-3">
                        <i data-lucide="map-pin" class="w-2.5 h-2.5 text-[var(--dix-light-green)]"></i>
                        <span id="detLoc"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t p-1.5 text-[8px] uppercase tracking-[0.3em] text-center text-gray-400 font-oswald flex-shrink-0">
        D.I.X. Autrement — Modélisation & Évaluation de circuits de proximité
    </footer>

    <script>
        // CONFIGURATION
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm_4bPCRFK_gGVkxP-ZeTHzLauhQtqNg_zG2chKNuY8-iyDAuHjc_CQbpBCU4LY9-GRi1579CsUkhr/pub?gid=917397259&single=true&output=csv";
        
        let COLS = {
            ANNEE: 0, REGION: 1, LOGO: 2, CLIENT: 3, TYPE: 4, CATEGORIE: 5, TITRE: 6, DESC: 7, VILLE: 9, LAT: 10, LNG: 11
        };

        let allData = [];
        let map, markersLayer;

        function updateLoaderStatus(status, hint = "") {
            const statusEl = document.getElementById('loaderStatus');
            const iconEl = document.getElementById('loaderIcon');
            if (statusEl) statusEl.textContent = status;
            if (status.includes("Erreur") && iconEl) iconEl.classList.remove('animate-spin');
        }

        window.onload = function() {
            try {
                if (window.lucide) lucide.createIcons();
                initMap();
                loadData();
            } catch (err) {
                updateLoaderStatus("Erreur Système");
            }
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([46.80, 2.50], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        function cleanUrl(text) {
            if (!text) return null;
            let url = text.trim();
            const match = url.match(/["'](http[^"']+)["']/i);
            if (match) return match[1];
            if (url.startsWith('http')) return url;
            return null;
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length < 2) {
                        updateLoaderStatus("Erreur : Fichier vide");
                        return;
                    }
                    const header = results.data[0];
                    const rows = results.data.slice(1);
                    
                    const findCol = (names) => header.findIndex(h => names.some(n => h.toLowerCase().includes(n.toLowerCase())));
                    const idxLat = findCol(['lat', 'latitude']);
                    const idxLng = findCol(['long', 'lng', 'longitude']);
                    const idxCat = findCol(['catégorie', 'thématique']);
                    const idxClient = findCol(['client', 'commanditaire']);
                    
                    if (idxLat !== -1) COLS.LAT = idxLat;
                    if (idxLng !== -1) COLS.LNG = idxLng;
                    if (idxCat !== -1) COLS.CATEGORIE = idxCat;
                    if (idxClient !== -1) COLS.CLIENT = idxClient;

                    allData = rows.map((row, index) => {
                        try {
                            const cleanCoord = (val) => String(val || "").replace(/\s/g, '').replace(',', '.').trim();
                            const lat = parseFloat(cleanCoord(row[COLS.LAT]));
                            const lng = parseFloat(cleanCoord(row[COLS.LNG]));
                            if (isNaN(lat) || isNaN(lng)) return null;
                            return {
                                id: index,
                                year: row[COLS.ANNEE] || "",
                                region: row[COLS.REGION] || "",
                                logo: cleanUrl(row[COLS.LOGO]),
                                client: row[COLS.CLIENT] || "Client",
                                category: row[COLS.CATEGORIE] || "AUTRE",
                                title: row[COLS.TITRE] || "Sans titre",
                                desc: row[COLS.DESC] || "",
                                city: row[COLS.VILLE] || "",
                                lat: lat,
                                lng: lng
                            };
                        } catch (err) { return null; }
                    }).filter(item => item !== null);

                    if (allData.length === 0) {
                        updateLoaderStatus("Erreur : GPS");
                        return;
                    }
                    renderFilters();
                    render(allData);
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('resultsList').classList.remove('hidden');
                },
                error: function(err) {
                    updateLoaderStatus("Erreur de lien");
                }
            });
        }

        function renderFilters() {
            const categories = [...new Set(allData.map(d => d.category))].filter(Boolean).sort();
            const select = document.getElementById('themeFilter');
            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c.toUpperCase();
                select.appendChild(opt);
            });
        }

        function render(data) {
            const listContainer = document.getElementById('resultsList');
            listContainer.innerHTML = '';
            markersLayer.clearLayers();
            const bounds = [];

            data.forEach(item => {
                const card = document.createElement('div');
                card.id = `card-${item.id}`;
                card.className = "bg-white rounded-lg cursor-pointer transition-all shadow-sm hover:shadow-md border border-gray-100 group overflow-hidden";
                
                // Organisation : Client en haut, Catégorie en dessous
                card.innerHTML = `
                    <div class="flex items-stretch h-full min-h-[100px]">
                        <div class="w-1/3 bg-gray-50 flex items-center justify-center p-2 border-r border-gray-50 flex-shrink-0">
                            ${item.logo 
                                ? `<img src="${item.logo}" class="max-h-16 w-full object-contain filter grayscale group-hover:grayscale-0 transition-all" alt="Logo">`
                                : `<div class="text-[var(--dix-dark-green)] opacity-10 font-oswald text-xl">${(item.client || "D").charAt(0)}</div>`
                            }
                        </div>
                        <div class="w-2/3 p-3 flex flex-col justify-center">
                            <h4 class="text-[10px] font-bold text-[var(--dix-dark-green)] font-oswald mb-0.5 leading-tight line-clamp-1">${item.client ? item.client.toUpperCase() : 'CLIENT'}</h4>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[7px] uppercase tracking-tighter text-[var(--dix-light-green)] font-bold">${item.category}</span>
                                <span class="text-[7px] font-bold px-1 py-0.5 bg-gray-100 rounded group-hover:bg-[var(--dix-light-green)] group-hover:text-white transition-colors">${item.year}</span>
                            </div>
                            <p class="text-[9px] leading-tight text-gray-500 italic line-clamp-2">${item.title || 'Sans titre'}</p>
                        </div>
                    </div>
                `;
                card.onclick = () => selectRef(item);
                listContainer.appendChild(card);

                const markerIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="marker-dot" style="background-color: var(--dix-light-green); width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`,
                    iconSize: [12, 12], iconAnchor: [6, 6]
                });
                L.marker([item.lat, item.lng], { icon: markerIcon }).addTo(markersLayer).on('click', () => selectRef(item));
                bounds.push([item.lat, item.lng]);
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [40, 40], maxZoom: 11, duration: 1.5 });
            }
        }

        function selectRef(item) {
            document.querySelectorAll('#resultsList > div').forEach(el => el.classList.remove('active-card'));
            const card = document.getElementById(`card-${item.id}`);
            if(card) {
                card.classList.add('active-card');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            map.flyTo([item.lat, item.lng], 11, { duration: 1.2 });
            
            document.getElementById('detTitle').textContent = item.title ? item.title.toUpperCase() : '';
            document.getElementById('detClient').textContent = item.client;
            document.getElementById('detYear').textContent = item.year;
            document.getElementById('detTheme').textContent = item.category.toUpperCase();
            document.getElementById('detDesc').textContent = item.desc;
            document.getElementById('detLoc').textContent = `${item.city || ''} (${item.region || ''})`;
            
            const logoCont = document.getElementById('detLogoContainer');
            const logoImg = document.getElementById('detLogo');
            if (item.logo) {
                logoImg.src = item.logo;
                logoCont.classList.remove('hidden');
            } else {
                logoCont.classList.add('hidden');
            }
            
            const panel = document.getElementById('detailPanel');
            if (window.innerWidth <= 768) {
                panel.style.transform = "translateY(0)";
            } else {
                panel.style.transform = "translateX(0)";
            }
        }

        function closeDetails() {
            const panel = document.getElementById('detailPanel');
            if (window.innerWidth <= 768) {
                panel.style.transform = "translateY(150%)";
            } else {
                panel.style.transform = "translateX(120%)";
            }
            document.querySelectorAll('#resultsList > div').forEach(el => el.classList.remove('active-card'));
        }

        document.getElementById('searchInput').oninput = filterData;
        document.getElementById('themeFilter').onchange = filterData;

        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const theme = document.getElementById('themeFilter').value;
            const filtered = allData.filter(d => {
                const matchesSearch = (d.title || "").toLowerCase().includes(search) || (d.client || "").toLowerCase().includes(search);
                const matchesTheme = theme === "" || d.category === theme;
                return matchesSearch && matchesTheme;
            });
            render(filtered);
            closeDetails();
        }
    </script>
</body>
</html>
